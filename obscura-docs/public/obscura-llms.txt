# OBSCURA API Documentation for LLMs
# Post-Quantum Secure Intent Settlement System with True Privacy

## Overview
Obscura is a post-quantum secure intent settlement system combining:
- WOTS+ (Winternitz One-Time Signatures) for quantum-resistant authorization
- SIP (Shielded Intent Protocol) for privacy-preserving transactions
- Stealth addresses for unlinkable payments
- Pedersen commitments for hidden amounts
- **Relayer Network** for true end-to-end privacy
- **Nullifier-based claims** for trustless withdrawals

Base URL: https://obscura-api.daemonprotocol.com

---

## DEPLOYED CONTRACTS

### Solana Devnet
- Program ID: `GG9U34H1xXkuzvv8Heoy4UWav5vUgrQFEVwrYMi84QuE`
- Vault PDA: `6owJu2yXoPvTbM67XwmRguVRQhCADaswHkAVhVHSvoH7`
- Vault State PDA: `5L1Vh6ftZWncYc1SEdZsoEX4DKaqCY6ZoQ3CdcEqursB`

### Sepolia Testnet (ETH)
- SIPVault: `0xc4937Ba6418eE72EDABF72694198024b5a3599CC`
- SIPSettlement: `0x88dA9c5D9801cb33615f0A516eb1098dF1889DA9`

---

## TRUE PRIVACY ARCHITECTURE

### The Problem with Basic Vaults
```
Basic Vault (Partial Privacy):
- Deposit: User_A ‚Üí Vault (User_A visible)
- Withdraw: User_A calls withdraw() ‚Üí Vault ‚Üí Recipient
- ‚ö†Ô∏è User_A visible as transaction initiator in withdrawal
```

### Obscura Solution: Relayer Pattern
```
True Privacy Flow:
1. DEPOSIT: User_A ‚Üí Vault (User_A visible, but unlinkable later)
   - User receives: commitment + nullifier (secret)

2. WITHDRAWAL REQUEST (Off-chain):
   - User sends to Relayer: nullifierHash + recipient + amount
   - User's identity NOT revealed to Relayer

3. RELAYER EXECUTION:
   - Relayer calls withdraw() on Vault
   - On-chain: Relayer ‚Üí Vault ‚Üí Recipient
   - ‚úÖ User_A's address NEVER appears in withdrawal
```

### Privacy Comparison
| Feature | Basic Vault | + Relayer | + ZK Proof |
|---------|-------------|-----------|------------|
| Deposit visible | ‚úÖ Yes | ‚úÖ Yes | ‚úÖ Yes |
| Withdrawal initiator hidden | ‚ùå No | ‚úÖ Yes | ‚úÖ Yes |
| Trustless verification | ‚ùå No | ‚ùå No | ‚úÖ Yes |
| Timing correlation | ‚ö†Ô∏è Possible | ‚ö†Ô∏è Reduced | ‚úÖ Minimal |

---

## ENDPOINTS

### 1. GET /
Get API information and available endpoints.

Response:
{
  "name": "Obscura API",
  "version": "0.4.0",
  "description": "Post-quantum secure intent settlement API with true privacy",
  "endpoints": {
    "health": "/health",
    "privacy": "/api/v1/privacy/status",
    "solana": "/api/v1/solana/status",
    "evm": "/api/v1/evm/status",
    "deposit": "/api/v1/deposit",
    "withdraw": "/api/v1/withdraw",
    "batches": "/api/v1/batches",
    "relayer": "/api/v1/relayer"
  }
}

---

### 2. GET /health
Health check endpoint.

Response:
{
  "status": "healthy",
  "timestamp": 1768491234567,
  "uptime": 3600,
  "services": {
    "auth": "ready",
    "aggregator": "ready",
    "solana": "ready",
    "evm": "ready"
  }
}

---

### 3. GET /api/v1/privacy/status
Get privacy layer configuration status.

Response:
{
  "arcium": {
    "configured": true,
    "clusterOffset": "123",
    "programId": "arcaborPMqYhZbLqPKPRXpBKyCMgH8kApNoxp4cLKg"
  },
  "lightProtocol": {
    "configured": true,
    "photonUrl": "https://devnet.helius-rpc.com"
  }
}

---

### 4. GET /api/v1/solana/status
Get Solana settlement status.

Response:
{
  "configured": true,
  "programId": "GG9U34H1xXkuzvv8Heoy4UWav5vUgrQFEVwrYMi84QuE",
  "vaultPda": "6owJu2yXoPvTbM67XwmRguVRQhCADaswHkAVhVHSvoH7",
  "vaultStatePda": "5L1Vh6ftZWncYc1SEdZsoEX4DKaqCY6ZoQ3CdcEqursB",
  "balance": "1234567890"
}

---

### 5. GET /api/v1/evm/status
Get EVM settlement status.

Response:
{
  "configured": true,
  "network": "sepolia",
  "vaultAddress": "0xc4937Ba6418eE72EDABF72694198024b5a3599CC",
  "settlementAddress": "0x88dA9c5D9801cb33615f0A516eb1098dF1889DA9",
  "balance": "1000000000000000000"
}

---

### 6. POST /api/v1/deposit
Create a deposit to the privacy vault. Returns deposit note with secrets.

Request Body (JSON):
{
  "network": "string",        // REQUIRED: solana-devnet, sepolia
  "token": "string",          // REQUIRED: native, usdc, usdt
  "amount": "string"          // REQUIRED: Amount as string
}

Success Response (201):
{
  "success": true,
  "depositNote": {
    "commitment": "0x...",      // Public - stored on-chain
    "nullifier": "abc123...",   // SECRET - keep safe!
    "nullifierHash": "0x...",   // Public - for replay protection
    "secret": "def456...",      // SECRET - keep safe!
    "amount": "5000000",
    "token": "native",
    "chainId": "solana-devnet",
    "timestamp": 1768491234567
  },
  "txHash": "5YiJ1SCm3CYoPhDp9VSunn1TAAvn6emDcpUCwTFyQXH6f4dBaZuuKALpDU7bv9Lm11AFfMoS1f56wUrknrvuaE55",
  "vaultAddress": "6owJu2yXoPvTbM67XwmRguVRQhCADaswHkAVhVHSvoH7"
}

‚ö†Ô∏è IMPORTANT: User must save `nullifier` and `secret` - these are needed for withdrawal!

---

### 7. POST /api/v1/withdraw
Submit withdrawal request to relayer for private execution.

Request Body (JSON):
{
  "commitment": "string",     // REQUIRED: From deposit note
  "nullifierHash": "string",  // REQUIRED: From deposit note
  "recipient": "string",      // REQUIRED: Destination address
  "amount": "string",         // REQUIRED: Amount to withdraw
  "chainId": "string"         // REQUIRED: solana-devnet, sepolia
}

Success Response (201):
{
  "success": true,
  "requestId": "3ae33176109d737e",
  "estimatedFee": "15000",
  "status": "pending"
}

After relayer executes:
{
  "success": true,
  "requestId": "3ae33176109d737e",
  "txHash": "5fmG66Xz8Uyv5Sfu6QfPUYYzcNaLPfgWVSZV5rijKmJKQ2UEu77hRoCdJBcZ9VoZyQxHP5DMsYb5VG77DhAGoSpS",
  "status": "completed",
  "zkCompressed": true,
  "compressionSignature": "3Ag8rUJB6tswcHubJ62aspEkJFf3QvShwCJPa4jgUsX2Pj3uTTzE6u27wDuAdLZnTJt2nBCkheGcrECnoFJMoCXb"
}

**ZK Compression Response Fields (Solana only):**
- `zkCompressed`: `true` if settlement was stored via Light Protocol ZK Compression
- `compressionSignature`: Transaction signature for compressed storage (viewable on Photon)

**Note:** ETH (Sepolia) withdrawals return `zkCompressed: false` - ZK Compression is Solana-only to preserve cross-chain privacy.

---

### 8. GET /api/v1/batches
Get pending batches.

Response:
{
  "batches": [
    {
      "batchId": "batch-123",
      "intentCount": 5,
      "status": "pending",
      "createdAt": 1768491234567
    }
  ]
}

---

### 9. POST /api/v1/batches/flush
Flush pending batches (force settlement).

Success Response (200):
{
  "success": true,
  "flushedBatches": 3,
  "totalIntents": 15
}

---

### 16. GET /api/v1/batches/:batchId
Get batch details.

Response:
{
  "batchId": "batch-123",
  "merkleRoot": "0x7a3b...",
  "intentCount": 5,
  "status": "settled",
  "txHash": "5fmG66Xz..."
}

---

### 17. GET /api/v1/relayer/stats
Get relayer service statistics.

Response:
{
  "totalDeposits": 42,
  "totalWithdrawals": 38,
  "totalVolume": "1500000000",
  "pendingRequests": 3,
  "usedNullifiers": 38
}

---

### 18. GET /api/v1/relayer/request/:requestId
Get withdrawal request status.

Response:
{
  "requestId": "3ae33176109d737e",
  "status": "pending|processing|completed|failed",
  "commitment": "0x...",
  "recipient": "ECYks1hYG3xVRyYpwaesqGrkpj9ZQh1R6S3T3KXDrhrA",
  "amount": "5000000",
  "chainId": "solana-devnet",
  "txHash": "5fmG66Xz...",
  "completedAt": 1768491234567
}

---

## DEPOSIT NOTE STRUCTURE

When user deposits, they receive a deposit note containing secrets:

```typescript
interface DepositNote {
  commitment: string;      // Public - hash of secrets, stored on-chain
  nullifier: string;       // SECRET - random 32 bytes, proves ownership
  nullifierHash: string;   // Public - hash(nullifier), for replay protection
  secret: string;          // SECRET - random 32 bytes, part of commitment
  amount: string;          // Amount deposited
  token: string;           // Token type
  chainId: string;         // Chain identifier
  timestamp: number;       // Deposit time
}
```

**Security:**
- `nullifier` and `secret` must NEVER be shared
- Only `nullifierHash` is sent to relayer (not `nullifier` itself)
- Commitment = hash(secret || nullifier || amount || token || chainId)

---

## RELAYER SERVICE

### How It Works
1. User deposits to vault ‚Üí gets deposit note
2. User sends withdrawal request to relayer with `nullifierHash`
3. Relayer verifies request and executes on-chain
4. On-chain shows: Relayer ‚Üí Vault ‚Üí Recipient
5. Original depositor is NOT visible in withdrawal tx

### Fee Structure
| Fee Type | Rate | Description |
|----------|------|-------------|
| Base Fee | 0.3% | Covers gas + operation |
| Min Fee (SOL) | 5000 lamports | ~$0.001 |
| Min Fee (ETH) | 0.0001 ETH | ~$0.30 |

### Nullifier Tracking
- Each nullifier can only be used ONCE
- Prevents double-spend attacks
- Tracked per-chain (same nullifier can be used on different chains)

---

## SUPPORTED CHAINS

| Chain | Chain ID | Type | Status | Vault |
|-------|----------|------|--------|-------|
| Solana Devnet | solana-devnet | SVM | ‚úÖ Active | 6owJu2...HSvoH7 |
| Sepolia | sepolia | EVM | ‚úÖ Active | 0xc4937...99CC |
| Ethereum | ethereum | EVM | üîú Soon | - |
| Polygon | polygon | EVM | üîú Soon | - |

---

## PRIVACY LEVELS

| Level | Description | Use Case |
|-------|-------------|----------|
| transparent | All data visible | Debugging, auditing |
| shielded | Maximum privacy (default) | Private transfers |
| compliant | Viewing keys enabled | Regulatory compliance |

---

## EXAMPLE FLOWS

### 1. Private SOL Transfer
```bash
# Step 1: Deposit
POST /api/v1/deposit
{
  "network": "solana-devnet",
  "token": "native",
  "amount": "5000000"
}
# Save the depositNote!

# Step 2: Request withdrawal (later, from different IP/device)
POST /api/v1/withdraw
{
  "commitment": "0x...",
  "nullifierHash": "0x...",
  "recipient": "ECYks1hYG3xVRyYpwaesqGrkpj9ZQh1R6S3T3KXDrhrA",
  "amount": "5000000",
  "chainId": "solana-devnet"
}
```

### 2. Private ETH Transfer
```bash
# Step 1: Deposit
POST /api/v1/deposit
{
  "network": "sepolia",
  "token": "native",
  "amount": "1000000000000000"
}

# Step 2: Request withdrawal
POST /api/v1/withdraw
{
  "commitment": "0x...",
  "nullifierHash": "0x...",
  "recipient": "0x0762BdEbFaB2A62055c6bc19bfdcF40AfB74251e",
  "amount": "1000000000000000",
  "chainId": "sepolia"
}
```

### 3. Private Transfer (Deposit Note Pattern)
```bash
# Step 1: Create transfer (get deposit note)
POST /api/v1/transfer
{
  "recipient": "ECYks1hYG3xVRyYpwaesqGrkpj9ZQh1R6S3T3KXDrhrA",
  "asset": "native",
  "amount": "5000000",
  "sourceChain": "solana-devnet",
  "privacyLevel": "shielded"
}
# Response includes depositNote

# Step 2: Sender deposits to vault (via wallet signature)
# ... user signs transaction ...

# Step 3: Sender sends deposit note to recipient (off-chain)
# QR code, link, encrypted message, etc.

# Step 4: Recipient withdraws using deposit note
POST /api/v1/withdraw
{
  "commitment": "0x...",
  "nullifierHash": "0x...",
  "recipient": "ECYks1hYG3xVRyYpwaesqGrkpj9ZQh1R6S3T3KXDrhrA",
  "amount": "5000000",
  "chainId": "solana-devnet"
}
```

---

## FRONTEND INTEGRATION

### Wallet Connection (No Private Key Needed!)
```typescript
// User connects wallet (Phantom, MetaMask)
const wallet = await connectWallet();

// User signs deposit transaction
const depositTx = await wallet.signTransaction(depositTransaction);

// Backend never sees private key!
```

### Deposit Flow
```typescript
// 1. Generate deposit note client-side
const depositNote = generateDepositNote(amount, chainId, token);

// 2. User signs and sends deposit tx via wallet
const txHash = await wallet.sendTransaction(depositTx);

// 3. Save deposit note locally (user's device only)
localStorage.setItem('depositNote', JSON.stringify(depositNote));
```

### Withdrawal Flow
```typescript
// 1. Load saved deposit note
const depositNote = JSON.parse(localStorage.getItem('depositNote'));

// 2. Send withdrawal request to relayer
const response = await fetch('/api/v1/withdraw', {
  method: 'POST',
  body: JSON.stringify({
    commitment: depositNote.commitment,
    nullifierHash: depositNote.nullifierHash,
    recipient: recipientAddress,
    amount: depositNote.amount,
    chainId: depositNote.chainId
  })
});

// 3. Relayer executes - user's address NOT visible!
```

---

## CRYPTOGRAPHIC PRIMITIVES

### Commitment Scheme
```
commitment = SHA256(secret || nullifier || amount || token || chainId)
nullifierHash = SHA256(nullifier)
```

### WOTS+ (Post-Quantum Signatures)
- Parameters: w=16, n=32, len=67
- One signature per key (one-time use)
- Quantum-resistant

### Stealth Addressing
- ECDH-based key derivation
- One-time addresses per transaction
- Unlinkable payments

---

## ZK COMPRESSION (Light Protocol)

### Overview
Obscura uses Light Protocol ZK Compression for Solana settlements, providing ~1000x cheaper state storage.

### Chain Support
| Chain | ZK Compression | Reason |
|-------|----------------|--------|
| Solana Devnet | ‚úÖ Enabled | Native integration, cost savings |
| Sepolia (ETH) | ‚ùå Disabled | Privacy - prevents cross-chain data correlation |

### Why ETH Doesn't Use ZK Compression
Storing ETH transaction hashes on Solana would create a cross-chain link that could be used to correlate deposits and withdrawals across chains, breaking privacy guarantees.

### Response Fields
When `zkCompressed: true`:
```json
{
  "zkCompressed": true,
  "compressionSignature": "3Ag8rUJB...",
  "photonUrl": "https://photon.helius.dev/tx/3Ag8rUJB...?cluster=devnet"
}
```

When `zkCompressed: false` (ETH or compression failed):
```json
{
  "zkCompressed": false
}
```

### Viewing Compressed Records
- Photon Explorer: `https://photon.helius.dev/tx/<signature>?cluster=devnet`
- Solana Explorer: `https://explorer.solana.com/tx/<signature>?cluster=devnet`

### Cost Savings
| Storage Type | 1000 Records | Cost |
|--------------|--------------|------|
| Traditional | 1000 accounts | ~2 SOL |
| ZK Compressed | 1 Merkle tree | ~0.002 SOL |

---

## ERROR CODES

| HTTP | Error | Description |
|------|-------|-------------|
| 400 | Missing required fields | Request validation failed |
| 400 | Nullifier already used | Double-spend attempt |
| 400 | Request expired | Withdrawal deadline passed |
| 404 | Not found | Resource not found |
| 500 | Relayer execution failed | On-chain tx failed |

---

## CHANGELOG

### v0.4.1 (Current)
- ‚úÖ **Cleanup**: Removed unused endpoints (stealth/scan, stealth/claim, intents, private-transfer, swap, quotes, pools)
- ‚úÖ **Single Wallet Mode**: Only one wallet (Solana OR EVM) can be connected at a time
- ‚úÖ **Dynamic UI**: Dashboard shows correct token logo (SOL/ETH) based on connected wallet
- ‚úÖ **Simplified API**: Only essential endpoints remain (deposit, withdraw, batches, status)

### v0.4.0
- ‚úÖ **Security Update**: Removed `/api/v1/transfer` endpoint (auto-withdrawal risk)
- ‚úÖ **Security Update**: Removed Transfer, Swap, Pools menus from dashboard
- ‚úÖ **UI Rename**: "Deposit" menu renamed to "Privacy Transfers"
- ‚úÖ **Daemon Engine**: Wallet risk scanning before withdrawal (Cyclops API)
- ‚úÖ Manual deposit ‚Üí send note ‚Üí recipient withdraw flow (safer)
- ‚úÖ Light Protocol ZK Compression for Solana settlements
- ‚úÖ zkCompressed field in withdraw response
- ‚úÖ Photon indexer integration
- ‚úÖ ETH withdrawals excluded from ZK Compression (privacy)

### v0.3.0
- ‚úÖ Status endpoints for privacy, Solana, EVM
- ‚úÖ Batch management
- ‚úÖ Frontend improvements (loading modal, amount conversion)

### v0.2.0
- ‚úÖ Relayer service for true privacy
- ‚úÖ Nullifier-based claims
- ‚úÖ Solana Devnet vault deployed
- ‚úÖ Sepolia ETH vault deployed
- ‚úÖ Double-spend protection
- ‚úÖ Multi-chain support

### v0.1.0
- Initial release
- Basic vault operations
- WOTS+ key pool management
