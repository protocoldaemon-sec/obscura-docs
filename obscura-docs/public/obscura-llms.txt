# OBSCURA API Documentation for LLMs
# Post-Quantum Secure Intent Settlement System with True Privacy

## Overview
Obscura is a post-quantum secure intent settlement system combining:
- WOTS+ (Winternitz One-Time Signatures) for quantum-resistant authorization
- SIP (Shielded Intent Protocol) for privacy-preserving transactions
- Stealth addresses for unlinkable payments
- Pedersen commitments for hidden amounts
- **Relayer Network** for true endlogs.1769431551612.log-to-end privacy
- **Nullifier-based claims** for trustless withdrawals

Base URL: https://otc-api.obscura-app.com

---

## DEPLOYED CONTRACTS

### Solana Devnet
- Program ID: `GG9U34H1xXkuzvv8Heoy4UWav5vUgrQFEVwrYMi84QuE`
- Vault PDA: `6owJu2yXoPvTbM67XwmRguVRQhCADaswHkAVhVHSvoH7`
- Vault State PDA: `5L1Vh6ftZWncYc1SEdZsoEX4DKaqCY6ZoQ3CdcEqursB`

### Sepolia Testnet (ETH)
- SIPVault: `0xc4937Ba6418eE72EDABF72694198024b5a3599CC`
- SIPSettlement: `0x88dA9c5D9801cb33615f0A516eb1098dF1889DA9`

---

## TRUE PRIVACY ARCHITECTURE

### The Problem with Basic Vaults
```
Basic Vault (Partial Privacy):
- Deposit: User_A ‚Üí Vault (User_A visible)
- Withdraw: User_A calls withdraw() ‚Üí Vault ‚Üí Recipient
- ‚ö†Ô∏è User_A visible as transaction initiator in withdrawal
- ‚ö†Ô∏è Vault PDA visible in withdrawal allows graph tracing
```

### Graph Tracing Attack
```
Hacker knows: Depositor wallet address
Attack vector: Depositor ‚Üí Vault PDA ‚Üí Recipient
Method: Check vault PDA transaction history
Result: Can trace depositor to recipient
```

### Obscura Solution: Off-Chain Balance Tracking + Direct Transfer

**1. Off-Chain Balance Tracking (Arcium cSPL)**

Instead of storing balances on-chain, Obscura uses Arcium's confidential computing to track balances off-chain:

```typescript
interface ConfidentialBalance {
  account: string;                    // Confidential account address
  encryptedBalance: EncryptedValue;   // Arcium Rescue cipher
  commitment: string;                 // Balance commitment
  sipCommitment: string;              // SIP commitment (for lookup)
  deposits: Array<{                   // Audit trail
    amount: bigint;
    txHash: string;
    timestamp: number;
  }>;
  withdrawals: Array<{
    amount: bigint;
    txHash: string;
    timestamp: number;
  }>;
}
```

**Benefits:**
- Balances encrypted with Arcium Rescue cipher
- No on-chain balance state
- MPC verification without decryption
- Audit trail for deposits/withdrawals

**2. Direct Transfer Method**

Instead of withdrawing from vault PDA, relayer transfers directly to recipient:

```
Traditional (Vulnerable):
Relayer calls withdraw() ‚Üí Vault PDA ‚Üí Recipient
Problem: Vault PDA visible in transaction

Obscura (Secure):
Relayer transfers directly ‚Üí Recipient
Result: NO vault PDA in transaction!
```

**Implementation:**
```typescript
// Direct transfer without vault PDA
async function directTransfer(
  recipient: PublicKey,
  amount: bigint,
  relayerKeypair: Keypair
): Promise<string> {
  const tx = new Transaction().add(
    SystemProgram.transfer({
      fromPubkey: relayerKeypair.publicKey,
      toPubkey: recipient,
      lamports: amount,
    })
  );
  
  return await sendAndConfirmTransaction(connection, tx, [relayerKeypair]);
}
```

**Privacy Flow:**
```
1. DEPOSIT: User ‚Üí Vault PDA (visible, but pooled)
   - Balance encrypted with Arcium cSPL
   - Stored off-chain in balance tracker
   - SIP commitment mapped to confidential account

2. VERIFICATION: Off-chain (private)
   - Check encrypted balance via MPC
   - Verify sufficient funds
   - No on-chain proof needed

3. WITHDRAWAL: Relayer ‚Üí Recipient (direct, NO vault PDA!)
   - Relayer transfers from own wallet
   - Vault PDA NOT in transaction
   - Balance updated off-chain

Result: Cannot trace depositor ‚Üí recipient via graph analysis
```

### Vault PDA Safety

The vault PDA address is **public and safe** because:

1. **One-Way Only**: Vault only receives deposits (IN), never sends withdrawals (OUT)
2. **Shared Resource**: All users deposit to same vault (pooling)
3. **Broken Link**: Withdrawals use direct transfer (no vault PDA in transaction)
4. **No Tracing**: Cannot link depositor ‚Üí recipient via vault history

```
Vault PDA Transaction History:
üì• Deposits: 1000+ transactions (User ‚Üí Vault)
üì§ Withdrawals: 0 transactions (Vault ‚Üí Recipient)

Result: Vault PDA is safe to be public!
```

### Verification Results

Real blockchain test (Solana Devnet):
- Deposit TX: `39dnonTjTqMa5P9rKucbqjLSMhQ5XSetzfdfAVyVZbYF2n3dEnxzRbZr6KnGAracf248MeJ2s8JU5e2oVNU9veqE`
- Withdrawal TX: `3VpcHMLQdaLqLLNLSVdVBvzY4t1PEkVFuCBf22gHH8meoaPKNfdYF51bAha849sBtZ9zhz8psQ8RAGhUAbgo7zDc`

Hacker Analysis Results:
- ‚ùå Vault PDA NOT in withdrawal transaction
- ‚ùå Withdrawal NOT in vault PDA history
- ‚ùå Cannot link depositor ‚Üí recipient
- ‚úÖ TRUE PRIVACY ACHIEVED

### Privacy Comparison

| Feature | Basic Vault | + Relayer | + Off-Chain Balance | + Direct Transfer |
|---------|-------------|-----------|---------------------|-------------------|
| Deposit visible | ‚úÖ Yes | ‚úÖ Yes | ‚úÖ Yes | ‚úÖ Yes |
| Withdrawal initiator hidden | ‚ùå No | ‚úÖ Yes | ‚úÖ Yes | ‚úÖ Yes |
| Vault PDA in withdrawal | ‚úÖ Yes | ‚úÖ Yes | ‚ùå No | ‚ùå No |
| Graph tracing possible | ‚úÖ Yes | ‚úÖ Yes | ‚ùå No | ‚ùå No |
| Balance privacy | ‚ùå On-chain | ‚ùå On-chain | ‚úÖ Encrypted | ‚úÖ Encrypted |
| **TRUE Privacy** | ‚ùå No | ‚ùå No | ‚úÖ Yes | ‚úÖ Yes |

### Obscura Solution: Relayer Pattern
```
True Privacy Flow:
1. DEPOSIT: User_A ‚Üí Vault (User_A visible, but unlinkable later)
   - User receives: commitment + nullifier (secret)

2. WITHDRAWAL REQUEST (Off-chain):
   - User sends to Relayer: nullifierHash + recipient + amount
   - User's identity NOT revealed to Relayer

3. RELAYER EXECUTION:
   - Relayer calls withdraw() on Vault
   - On-chain: Relayer ‚Üí Vault ‚Üí Recipient
   - ‚úÖ User_A's address NEVER appears in withdrawal
```

### Privacy Comparison
| Feature | Basic Vault | + Relayer | + ZK Proof |
|---------|-------------|-----------|------------|
| Deposit visible | ‚úÖ Yes | ‚úÖ Yes | ‚úÖ Yes |
| Withdrawal initiator hidden | ‚ùå No | ‚úÖ Yes | ‚úÖ Yes |
| Trustless verification | ‚ùå No | ‚ùå No | ‚úÖ Yes |
| Timing correlation | ‚ö†Ô∏è Possible | ‚ö†Ô∏è Reduced | ‚úÖ Minimal |

---

## BACKEND ARCHITECTURE

### Core Components

**1. Balance Tracker (`balance-tracker.ts`)**
- Off-chain encrypted balance storage
- Maps SIP commitment ‚Üí confidential account
- Tracks deposit/withdrawal history
- Verifies withdrawal eligibility without on-chain proof

**2. Solana Settlement (`settlement.ts`)**
- Direct transfer method (no vault PDA)
- Arcium cSPL integration
- Light Protocol ZK Compression
- Multi-chain support

**3. Arcium cSPL (`cspl-real.ts`)**
- Real Rescue cipher encryption
- Confidential account management
- MPC-based balance verification
- Deposit/withdrawal instructions

**4. Server (`server.ts`)**
- Deposit endpoint: Records balance in tracker
- Withdrawal endpoint: Verifies off-chain, executes direct transfer
- ZK Compression for Solana settlements only
- Fee calculation and deduction

### Withdrawal Flow (Backend)

```typescript
// 1. Receive withdrawal request
POST /api/v1/withdraw
{
  commitment: "0x...",
  nullifierHash: "0x...",
  recipient: "5CBiq8BY...",
  amount: "76767600",
  chainId: "solana-devnet"
}

// 2. Look up confidential account
const account = balanceTracker.getAccountBySIPCommitment(commitment);

// 3. Verify balance off-chain
const verification = await balanceTracker.verifyWithdrawal(account, amount);
if (!verification.valid) {
  return error("Insufficient balance");
}

// 4. Execute direct transfer (NO VAULT PDA!)
const txHash = await solanaSettlement.directTransfer(
  recipient,
  amount,
  relayerKeypair
);

// 5. Update off-chain balance
balanceTracker.recordWithdrawal(account, amount, newEncryptedBalance, txHash);

// 6. Optional: ZK Compression (Solana only)
if (chainId === 'solana-devnet') {
  const compressionSig = await lightProtocol.storeSettlementRecord({
    batchId: `withdraw_${Date.now()}`,
    chain: 'solana',
    txHash,
    status: 'confirmed',
  });
}

// 7. Return result
return {
  success: true,
  txHash,
  zkCompressed: true,
  compressionSignature: compressionSig
};
```

### Key Design Decisions

**1. Why Off-Chain Balance Tracking?**
- On-chain balance state would be visible
- Vault PDA in withdrawal enables graph tracing
- Off-chain storage breaks the link

**2. Why Direct Transfer?**
- Vault PDA NOT in withdrawal transaction
- Cannot trace depositor ‚Üí recipient
- Graph analysis attack fails

**3. Why Arcium cSPL?**
- Real encryption (Rescue cipher)
- MPC verification without decryption
- Confidential computing guarantees

**4. Why ZK Compression Only for Solana?**
- ETH transaction hashes on Solana would leak cross-chain correlation
- Solana-only compression preserves privacy
- ~1000x cost savings for Solana settlements

### Privacy Guarantees

**What's Hidden:**
- ‚úÖ Depositor identity (not in withdrawal)
- ‚úÖ Balance amounts (encrypted off-chain)
- ‚úÖ Vault PDA link (not in withdrawal transaction)
- ‚úÖ Withdrawal initiator (relayer, not user)

**What's Visible:**
- ‚ö†Ô∏è Deposit transaction (User ‚Üí Vault PDA)
- ‚ö†Ô∏è Withdrawal transaction (Relayer ‚Üí Recipient)
- ‚ö†Ô∏è Amounts (unless using fixed denominations)
- ‚ö†Ô∏è Timing (unless batched with others)

**What's Broken:**
- ‚ùå Depositor ‚Üí Recipient link (no vault PDA in withdrawal)
- ‚ùå Graph tracing (vault history shows no withdrawals)
- ‚ùå Balance correlation (encrypted off-chain)

---

## ENDPOINTS

### 1. GET /
Get API information and available endpoints.

Response:
{
  "name": "Obscura API",
  "version": "0.5.2",
  "description": "Post-quantum secure intent settlement API with true privacy",
  "changelog": {
    "0.5.2": [
      "Balance query endpoint (POST /api/v1d:\script\express\obscura-dark-otc-be\obscura-dark-otc-rfq-llms.txtd:\script\express\obscura-dark-otc-be\obscura-dark-otc-rfq-llms.txt)",
      "Real-time vault balance updates from Arcium cSPL",
      "Dark OTC integration with automatic balance refresh",
      "Off-chain balance verification without on-chain queries"
    ],
    "0.5.1": [
      "Minimum deposit requirement (0.0003 SOL/ETH)",
      "Frontend validation enhancements",
      "Loading modal UX improvements",
      "Console security hardening"
    ],
    "0.5.0": [
      "Arcium MPC integration (v0.6.3, cluster offset 456)",
      "Confidential solver auctions",
      "Intent encryption with real Arcium SDK",
      "Batch optimization via MPC",
      "Compliance disclosure (COMPLIANT mode)",
      "Enhanced privacy status endpoint"
    ],
    "0.4.0": [
      "Light Protocol ZK Compression",
      "Relayer network for private withdrawals",
      "Tiered fee structure"
    ]
  },
  "endpoints": {
    "health": "/health",
    "privacy": "/api/v1/privacy/status",
    "solana": "/api/v1/solana/status",
    "evm": "/api/v1/evm/status",
    "deposit": "/api/v1/deposit",
    "balance": "/api/v1/balance",
    "withdraw": "/api/v1/withdraw",
    "batches": "/api/v1/batches",
    "relayer": "/api/v1/relayer"
  }
}

---

### 2. GET /health
Health check endpoint.

Response:
{
  "status": "healthy",
  "timestamp": 1768491234567,
  "uptime": 3600,
  "services": {
    "auth": "ready",
    "aggregator": "ready",
    "solana": "ready",
    "evm": "ready"
  }
}

---

### 3. GET /api/v1/privacy/status
Get privacy layer configuration status including Arcium MPC and Light Protocol ZK Compression.

Response:
{
  "status": "operational",
  "timestamp": "2026-01-19T12:00:00.000Z",
  
  "features": {
    "pedersenCommitments": true,
    "stealthAddresses": true,
    "batchSettlement": true,
    "wotsAuthorization": true,
    "confidentialComputing": true
  },
  
  "arcium": {
    "configured": true,
    "clusterOffset": "456",
    "version": "v0.6.3",
    "programId": "arcaborPMqYhZbLqPKPRXpBKyCMgH8kApNoxp4cLKg",
    "deployment": {
      "mxeId": "abc123...",
      "status": "deployed",
      "participants": 3
    },
    "features": {
      "intentEncryption": true,
      "confidentialAuctions": true,
      "batchOptimization": true,
      "complianceDisclosure": true
    },
    "useCases": [
      "Fair solver auctions (no bid visibility)",
      "Private intent amounts (no front-running)",
      "Encrypted batch optimization",
      "Selective compliance disclosure"
    ]
  },
  
  "lightProtocol": {
    "configured": true,
    "photonUrl": "configured",
    "stateTree": "configured",
    "features": {
      "zkCompression": true,
      "compressedPDAs": true,
      "costSavings": "~1000x cheaper storage"
    }
  },
  
  "privacyLevels": {
    "transparent": "All visible - for debugging/auditing",
    "shielded": "Sender, recipient, amount hidden - maximum privacy",
    "compliant": "Encrypted with viewing keys - regulatory friendly (uses Arcium sealing)"
  },
  
  "chains": {
    "solana": {
      "configured": true,
      "network": "devnet",
      "programId": "GG9U34H1xXkuzvv8Heoy4UWav5vUgrQFEVwrYMi84QuE",
      "features": ["ZK Compression", "Arcium MPC"]
    },
    "ethereum": {
      "configured": true,
      "network": "sepolia",
      "settlement": "0x88dA9c5D9801cb33615f0A516eb1098dF1889DA9",
      "vault": "0xc4937Ba6418eE72EDABF72694198024b5a3599CC",
      "features": ["Pedersen Commitments", "Stealth Addresses"]
    }
  }
}

---

### 4. GET /api/v1/solana/status
Get Solana settlement status.

Response:
{
  "configured": true,
  "programId": "GG9U34H1xXkuzvv8Heoy4UWav5vUgrQFEVwrYMi84QuE",
  "vaultPda": "6owJu2yXoPvTbM67XwmRguVRQhCADaswHkAVhVHSvoH7",
  "vaultStatePda": "5L1Vh6ftZWncYc1SEdZsoEX4DKaqCY6ZoQ3CdcEqursB",
  "balance": "1234567890"
}

---

### 5. GET /api/v1/evm/status
Get EVM settlement status.

Response:
{
  "configured": true,
  "network": "sepolia",
  "vaultAddress": "0xc4937Ba6418eE72EDABF72694198024b5a3599CC",
  "settlementAddress": "0x88dA9c5D9801cb33615f0A516eb1098dF1889DA9",
  "balance": "1000000000000000000"
}

---

### 6. POST /api/v1/deposit
Create a deposit to the privacy vault. Returns deposit note with secrets.

**Minimum Deposit:** 0.0003 SOL or 0.0003 ETH

Request Body (JSON):
{
  "network": "string",        // REQUIRED: solana-devnet, sepolia
  "token": "string",          // REQUIRED: native, usdc, usdt
  "amount": "string"          // REQUIRED: Amount as string (min: 0.0003)
}

Success Response (201):
{
  "success": true,
  "depositNote": {
    "commitment": "0x...",      // Public - stored on-chain
    "nullifier": "abc123...",   // SECRET - keep safe!
    "nullifierHash": "0x...",   // Public - for replay protection
    "secret": "def456...",      // SECRET - keep safe!
    "amount": "5000000",
    "token": "native",
    "chainId": "solana-devnet",
    "timestamp": 1768491234567
  },
  "txHash": "5YiJ1SCm3CYoPhDp9VSunn1TAAvn6emDcpUCwTFyQXH6f4dBaZuuKALpDU7bv9Lm11AFfMoS1f56wUrknrvuaE55",
  "vaultAddress": "6owJu2yXoPvTbM67XwmRguVRQhCADaswHkAVhVHSvoH7"
}

Error Response (400) - Amount Too Low:
{
  "success": false,
  "error": "Amount too low",
  "details": "Minimum deposit is 0.0003 SOL"
}

‚ö†Ô∏è IMPORTANT: 
- User must save `nullifier` and `secret` - these are needed for withdrawal!
- Minimum deposit: 0.0003 SOL or 0.0003 ETH (to cover relayer fees and gas)

---

### 6.1. POST /api/v1/balance
Query vault balance from Arcium cSPL off-chain balance tracker.

**Purpose:** Get current vault balance after deposits/withdrawals. This queries the Arcium cSPL encrypted balance, NOT the wallet balance.

**Why This Endpoint?**
- After settlement, vault balance updates in Arcium cSPL (off-chain)
- Frontend needs to query actual vault balance, not just localStorage
- Enables real-time balance display after Dark OTC trades

Request Body (JSON):
{
  "commitment": "string",     // REQUIRED: From deposit note
  "chainId": "string"         // REQUIRED: solana-devnet (only Solana supported)
}

Success Response (200):
{
  "success": true,
  "balance": "1200000000",              // Available balance in base units (lamports)
  "pendingBalance": "0",                // Pending withdrawals
  "confidentialAccount": "5599a875...", // Arcium cSPL account address
  "encrypted": true,                    // Balance is encrypted on-chain
  "token": "native",                    // Token type (native = SOL)
  "deposits": 1,                        // Number of deposits
  "withdrawals": 0                      // Number of withdrawals
}

Error Response (404) - No Balance Found:
{
  "success": false,
  "error": "No vault balance found for this commitment",
  "details": "Please deposit first to create a vault balance"
}

Error Response (400) - Wrong Chain:
{
  "success": false,
  "error": "Balance query only supported on Solana (Arcium cSPL)",
  "details": "EVM chains do not support off-chain balance tracking yet"
}

**Example Usage:**
```typescript
// Query vault balance after deposit or settlement
const response = await fetch('https://api.obscura-app.com/api/v1/balance', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    commitment: 'b4083a81a64f7bf5...',
    chainId: 'solana-devnet'
  })
});

const result = await response.json();
console.log('Vault balance:', result.balance / 1e9, 'SOL');
console.log('Confidential account:', result.confidentialAccount);
```

**Notes:**
- Balance is stored off-chain in Arcium cSPL (encrypted)
- Updates automatically after deposits/withdrawals/settlements
- Only Solana supported (Arcium cSPL is Solana-only)
- Returns balance in base units (lamports for SOL, divide by 1e9 for display)

---

### 7. POST /api/v1/withdraw
Submit withdrawal request to relayer for private execution.

Request Body (JSON):
{
  "commitment": "string",     // REQUIRED: From deposit note
  "nullifierHash": "string",  // REQUIRED: From deposit note
  "recipient": "string",      // REQUIRED: Destination address
  "amount": "string",         // REQUIRED: Amount to withdraw
  "chainId": "string"         // REQUIRED: solana-devnet, sepolia
}

Success Response (201):
{
  "success": true,
  "requestId": "3ae33176109d737e",
  "estimatedFee": "15000",
  "status": "pending"
}

After relayer executes:
{
  "success": true,
  "requestId": "3ae33176109d737e",
  "txHash": "5fmG66Xz8Uyv5Sfu6QfPUYYzcNaLPfgWVSZV5rijKmJKQ2UEu77hRoCdJBcZ9VoZyQxHP5DMsYb5VG77DhAGoSpS",
  "status": "completed",
  "zkCompressed": true,
  "compressionSignature": "3Ag8rUJB6tswcHubJ62aspEkJFf3QvShwCJPa4jgUsX2Pj3uTTzE6u27wDuAdLZnTJt2nBCkheGcrECnoFJMoCXb"
}

**ZK Compression Response Fields (Solana only):**
- `zkCompressed`: `true` if settlement was stored via Light Protocol ZK Compression
- `compressionSignature`: Transaction signature for compressed storage (viewable on Photon)

**Note:** ETH (Sepolia) withdrawals return `zkCompressed: false` - ZK Compression is Solana-only to preserve cross-chain privacy.

---

### 8. GET /api/v1/batches
Get pending batches.

Response:
{
  "batches": [
    {
      "batchId": "batch-123",
      "intentCount": 5,
      "status": "pending",
      "createdAt": 1768491234567
    }
  ]
}

---

### 9. POST /api/v1/batches/flush
Flush pending batches (force settlement).

Success Response (200):
{
  "success": true,
  "flushedBatches": 3,
  "totalIntents": 15
}

---

### 16. GET /api/v1/batches/:batchId
Get batch details.

Response:
{
  "batchId": "batch-123",
  "merkleRoot": "0x7a3b...",
  "intentCount": 5,
  "status": "settled",
  "txHash": "5fmG66Xz..."
}

---

### 17. GET /api/v1/relayer/stats
Get relayer service statistics.

Response:
{
  "totalDeposits": 42,
  "totalWithdrawals": 38,
  "totalVolume": "1500000000",
  "pendingRequests": 3,
  "usedNullifiers": 38
}

---

### 18. GET /api/v1/relayer/request/:requestId
Get withdrawal request status.

Response:
{
  "requestId": "3ae33176109d737e",
  "status": "pending|processing|completed|failed",
  "commitment": "0x...",
  "recipient": "ECYks1hYG3xVRyYpwaesqGrkpj9ZQh1R6S3T3KXDrhrA",
  "amount": "5000000",
  "chainId": "solana-devnet",
  "txHash": "5fmG66Xz...",
  "completedAt": 1768491234567
}

---

## DEPOSIT NOTE STRUCTURE

When user deposits, they receive a deposit note containing secrets:

```typescript
interface DepositNote {
  commitment: string;      // Public - hash of secrets, stored on-chain
  nullifier: string;       // SECRET - random 32 bytes, proves ownership
  nullifierHash: string;   // Public - hash(nullifier), for replay protection
  secret: string;          // SECRET - random 32 bytes, part of commitment
  amount: string;          // Amount deposited
  token: string;           // Token type
  chainId: string;         // Chain identifier
  timestamp: number;       // Deposit time
}
```

**Security:**
- `nullifier` and `secret` must NEVER be shared
- Only `nullifierHash` is sent to relayer (not `nullifier` itself)
- Commitment = hash(secret || nullifier || amount || token || chainId)

---

## RELAYER SERVICE

### How It Works
1. User deposits to vault ‚Üí gets deposit note
2. User sends withdrawal request to relayer with `nullifierHash`
3. Relayer verifies request and executes on-chain
4. On-chain shows: Relayer ‚Üí Vault ‚Üí Recipient
5. Original depositor is NOT visible in withdrawal tx

### Fee Structure (Tiered Pricing)
| Amount | Fee Rate | Example |
|--------|----------|---------|
| 0-10 SOL/ETH | 0.10% | 10 SOL ‚Üí 0.01 SOL fee |
| 10-100 SOL/ETH | 0.08% | 100 SOL ‚Üí 0.08 SOL fee |
| 100-1000 SOL/ETH | 0.06% | 1000 SOL ‚Üí 0.6 SOL fee |
| 1000+ SOL/ETH | 0.05% | 10000 SOL ‚Üí 5 SOL fee |

| Minimum Fee | Amount |
|-------------|--------|
| SOL | 0.0001 SOL (100,000 lamports) |
| ETH | 0.00001 ETH |

**Fee Calculation:**
- Fee is automatically deducted from withdrawal amount
- User receives: `depositAmount - fee`
- Fee stays in vault (covers relayer gas + protocol revenue)

### Nullifier Tracking
- Each nullifier can only be used ONCE
- Prevents double-spend attacks
- Tracked per-chain (same nullifier can be used on different chains)

---

## SUPPORTED CHAINS

| Chain | Chain ID | Type | Status | Vault |
|-------|----------|------|--------|-------|
| Solana Devnet | solana-devnet | SVM | ‚úÖ Active | 6owJu2...HSvoH7 |
| Sepolia | sepolia | EVM | ‚úÖ Active | 0xc4937...99CC |
| Ethereum | ethereum | EVM | üîú Soon | - |
| Polygon | polygon | EVM | üîú Soon | - |

---

## PRIVACY LEVELS

| Level | Description | Use Case |
|-------|-------------|----------|
| transparent | All data visible | Debugging, auditing |
| shielded | Maximum privacy (default) | Private transfers |
| compliant | Viewing keys enabled | Regulatory compliance |

---

## EXAMPLE FLOWS

### 1. Private SOL Transfer
```bash
# Step 1: Deposit
POST /api/v1/deposit
{
  "network": "solana-devnet",
  "token": "native",
  "amount": "5000000"
}
# Save the depositNote!

# Step 2: Request withdrawal (later, from different IP/device)
POST /api/v1/withdraw
{
  "commitment": "0x...",
  "nullifierHash": "0x...",
  "recipient": "ECYks1hYG3xVRyYpwaesqGrkpj9ZQh1R6S3T3KXDrhrA",
  "amount": "5000000",
  "chainId": "solana-devnet"
}
```

### 2. Private ETH Transfer
```bash
# Step 1: Deposit
POST /api/v1/deposit
{
  "network": "sepolia",
  "token": "native",
  "amount": "1000000000000000"
}

# Step 2: Request withdrawal
POST /api/v1/withdraw
{
  "commitment": "0x...",
  "nullifierHash": "0x...",
  "recipient": "0x0762BdEbFaB2A62055c6bc19bfdcF40AfB74251e",
  "amount": "1000000000000000",
  "chainId": "sepolia"
}
```

### 3. Private Transfer (Deposit Note Pattern)
```bash
# Step 1: Create transfer (get deposit note)
POST /api/v1/transfer
{
  "recipient": "ECYks1hYG3xVRyYpwaesqGrkpj9ZQh1R6S3T3KXDrhrA",
  "asset": "native",
  "amount": "5000000",
  "sourceChain": "solana-devnet",
  "privacyLevel": "shielded"
}
# Response includes depositNote

# Step 2: Sender deposits to vault (via wallet signature)
# ... user signs transaction ...

# Step 3: Sender sends deposit note to recipient (off-chain)
# QR code, link, encrypted message, etc.

# Step 4: Recipient withdraws using deposit note
POST /api/v1/withdraw
{
  "commitment": "0x...",
  "nullifierHash": "0x...",
  "recipient": "ECYks1hYG3xVRyYpwaesqGrkpj9ZQh1R6S3T3KXDrhrA",
  "amount": "5000000",
  "chainId": "solana-devnet"
}
```

---

## FRONTEND INTEGRATION

### Wallet Connection (No Private Key Needed!)
```typescript
// User connects wallet (Phantom, MetaMask)
const wallet = await connectWallet();

// User signs deposit transaction
const depositTx = await wallet.signTransaction(depositTransaction);

// Backend never sees private key!
```

### Deposit Flow
```typescript
// 1. Generate deposit note client-side
const depositNote = generateDepositNote(amount, chainId, token);

// 2. User signs and sends deposit tx via wallet
const txHash = await wallet.sendTransaction(depositTx);

// 3. Save deposit note locally (user's device only)
localStorage.setItem('depositNote', JSON.stringify(depositNote));
```

### Withdrawal Flow
```typescript
// 1. Load saved deposit note
const depositNote = JSON.parse(localStorage.getItem('depositNote'));

// 2. Send withdrawal request to relayer
const response = await fetch('/api/v1/withdraw', {
  method: 'POST',
  body: JSON.stringify({
    commitment: depositNote.commitment,
    nullifierHash: depositNote.nullifierHash,
    recipient: recipientAddress,
    amount: depositNote.amount,
    chainId: depositNote.chainId
  })
});

// 3. Relayer executes - user's address NOT visible!
```

---

## CRYPTOGRAPHIC PRIMITIVES

### Commitment Scheme
```
commitment = SHA256(secret || nullifier || amount || token || chainId)
nullifierHash = SHA256(nullifier)
```

### WOTS+ (Post-Quantum Signatures)
- Parameters: w=16, n=32, len=67
- One signature per key (one-time use)
- Quantum-resistant

### Stealth Addressing
- ECDH-based key derivation
- One-time addresses per transaction
- Unlinkable payments

---

## ARCIUM MPC (Confidential Computing)

### Overview
Obscura uses Arcium for Multi-Party Computation (MPC) to enable confidential computing on encrypted data without decryption.

### Version & Configuration
| Component | Value |
|-----------|-------|
| Arcium Version | v0.6.3 |
| Cluster Offset | 456 (Solana Devnet) |
| Program ID | arcaborPMqYhZbLqPKPRXpBKyCMgH8kApNoxp4cLKg |
| SDK | @arcium-hq/client v0.6.1 |

### Installation
```bash
# Install Arcium tooling
curl --proto '=https' --tlsv1.2 -sSfL https://install.arcium.com/ | bash

# Deploy MXE to devnet
arcium deploy --cluster-offset 456 \
  --keypair-path ~/.config/solana/id.json \
  --rpc-url https://devnet.helius-rpc.com/?api-key=YOUR_KEY \
  --mempool-size Tiny
```

### Use Cases in Obscura

#### 1. Confidential Solver Auctions
Solvers submit encrypted bids for intent execution. Arcium MPC computes the best solver without revealing individual bids.

**Benefits:**
- Fair price discovery (no bid sniping)
- Prevents solver collusion
- Protects solver strategies

#### 2. Intent Encryption
User intents (amount, token, recipient) are encrypted before batching. Only the MPC network can process them.

**Benefits:**
- Prevents front-running
- Hides trading patterns
- Protects user privacy

#### 3. Batch Optimization
Encrypted intents are optimized for routing and gas efficiency via MPC computation.

**Benefits:**
- Better execution prices
- Lower gas costs
- Privacy-preserving optimization

#### 4. Compliance Disclosure (COMPLIANT Mode)
Regulatory viewing keys are sealed via Arcium. Only authorized parties can decrypt transaction details.

**Benefits:**
- Selective disclosure for compliance
- Maintains privacy for non-regulated users
- Auditable without compromising privacy

### Privacy Levels with Arcium

| Level | Arcium Usage | Description |
|-------|--------------|-------------|
| `TRANSPARENT` | None | All data visible on-chain |
| `SHIELDED` | Intent encryption | Maximum privacy, no viewing keys |
| `COMPLIANT` | Sealed viewing keys | Encrypted with regulatory access |

### Integration Flow

```typescript
// 1. Encrypt intent via Arcium
const encryptedIntent = await arciumClient.encryptIntent({
  tokenIn: 'SOL',
  tokenOut: 'USDC',
  amountIn: '5.0',
  recipient: 'ECYks1hYG3xVRyYpwaesqGrkpj9ZQh1R6S3T3KXDrhrA',
});

// 2. Submit to aggregator
const intentId = await aggregator.submitIntent(encryptedIntent);

// 3. MPC processes encrypted batch
const optimizedBatch = await arciumClient.optimizeBatch(encryptedIntents);

// 4. Settlement on-chain (only commitments visible)
const txHash = await executor.settleBatch(optimizedBatch);
```

### Encryption Details
- **Cipher**: RescueCipher (Arcium's custom cipher)
- **Key Management**: Distributed across MPC nodes
- **Decryption**: Only possible via MPC computation (no single party can decrypt)

### Cost Comparison
| Operation | Without Arcium | With Arcium |
|-----------|----------------|-------------|
| Intent submission | Public | Encrypted |
| Solver auction | Visible bids | Confidential bids |
| Batch optimization | Public routing | Private routing |
| Compliance | No viewing keys | Sealed viewing keys |

### Viewing Arcium Transactions
- Arcium Explorer: `https://explorer.arcium.com/tx/<mxe_id>?cluster=devnet`
- Solana Explorer: `https://explorer.solana.com/tx/<signature>?cluster=devnet`

**Note:** Encrypted data appears as ciphertext on-chain. Only MPC participants can process it.

---

## ZK COMPRESSION (Light Protocol)

### Overview
Obscura uses Light Protocol ZK Compression for Solana settlements, providing ~1000x cheaper state storage.

### Chain Support
| Chain | ZK Compression | Reason |
|-------|----------------|--------|
| Solana Devnet | ‚úÖ Enabled | Native integration, cost savings |
| Sepolia (ETH) | ‚ùå Disabled | Privacy - prevents cross-chain data correlation |

### Why ETH Doesn't Use ZK Compression
Storing ETH transaction hashes on Solana would create a cross-chain link that could be used to correlate deposits and withdrawals across chains, breaking privacy guarantees.

### Response Fields
When `zkCompressed: true`:
```json
{
  "zkCompressed": true,
  "compressionSignature": "3Ag8rUJB...",
  "photonUrl": "https://photon.helius.dev/tx/3Ag8rUJB...?cluster=devnet"
}
```

When `zkCompressed: false` (ETH or compression failed):
```json
{
  "zkCompressed": false
}
```

### Viewing Compressed Records
- Photon Explorer: `https://photon.helius.dev/tx/<signature>?cluster=devnet`
- Solana Explorer: `https://explorer.solana.com/tx/<signature>?cluster=devnet`

### Cost Savings
| Storage Type | 1000 Records | Cost |
|--------------|--------------|------|
| Traditional | 1000 accounts | ~2 SOL |
| ZK Compressed | 1 Merkle tree | ~0.002 SOL |

---

## ERROR CODES

| HTTP | Error | Description |
|------|-------|-------------|
| 400 | Missing required fields | Request validation failed |
| 400 | Nullifier already used | Double-spend attempt |
| 400 | Request expired | Withdrawal deadline passed |
| 404 | Not found | Resource not found |
| 500 | Relayer execution failed | On-chain tx failed |

---

## CHANGELOG

### v0.5.2 (Current)
- ‚úÖ **Balance Query Endpoint**: New `POST /api/v1/balance` endpoint to query Arcium cSPL off-chain balance
- ‚úÖ **Real-Time Balance Updates**: Frontend queries vault balance from API after settlements
- ‚úÖ **Dark OTC Integration**: Vault balance updates automatically after Dark OTC trades
- ‚úÖ **Off-Chain Balance Verification**: Balance tracker provides encrypted balance without on-chain queries
- ‚úÖ **Solana-Only Support**: Balance query only available for Solana (Arcium cSPL)

### v0.5.1
- ‚úÖ **Minimum Deposit Requirement**: 0.0003 SOL/ETH minimum to cover relayer fees and gas
- ‚úÖ **Frontend Validation**: Real-time validation with warning for amounts below minimum
- ‚úÖ **Loading Modal Enhancement**: Green spinning animation at 100% completion before close
- ‚úÖ **Console Security**: Removed commitment logging from frontend for enhanced privacy

### v0.5.0
- ‚úÖ **Arcium MPC Integration**: Real confidential computing via Arcium v0.6.3 (cluster offset 456)
- ‚úÖ **Confidential Solver Auctions**: Fair solver selection without bid visibility
- ‚úÖ **Intent Encryption**: Private intent amounts prevent front-running with real Arcium SDK
- ‚úÖ **Batch Optimization via MPC**: Encrypted batch optimization for better routing
- ‚úÖ **Compliance Disclosure**: COMPLIANT mode uses Arcium sealing for regulatory viewing keys
- ‚úÖ **Enhanced Privacy Status**: `/api/v1/privacy/status` shows Arcium deployment status
- ‚úÖ **ZK Privacy Pool**: Tornado Cash style anonymity set with Merkle tree (20 levels = 1M capacity)
- ‚úÖ **DUAL Privacy Layer**: SIPClient (whitepaper) + ZK Pool with transparent bridge
- ‚úÖ **Light Protocol Compression**: Hide depositor info in compressed state (not visible on-chain)
- ‚úÖ **Off-Chain Balance Tracking**: Balances encrypted with Arcium cSPL, stored off-chain
- ‚úÖ **Direct Transfer Method**: Withdrawals bypass vault PDA (Relayer ‚Üí Recipient directly)
- ‚úÖ **Graph Tracing Prevention**: Vault PDA NOT in withdrawal transaction
- ‚úÖ **Privacy Verification**: Real blockchain test confirms TRUE privacy
- ‚úÖ **Vault PDA Safety**: Public vault address is safe (one-way deposits only)
- ‚úÖ **Double Transfer Bug Fix**: Fixed duplicate withdrawal execution
- ‚úÖ **Balance Tracker**: Maps SIP commitment ‚Üí confidential account for withdrawal lookup

### v0.4.0
- ‚úÖ **Light Protocol ZK Compression**: ~1000x cheaper state storage
- ‚úÖ **Relayer Network**: Private withdrawals via relayer execution
- ‚úÖ **Tiered Fee Structure**: Volume-based pricing (0.05% - 0.10%)

### v0.3.0
- ‚úÖ Status endpoints for privacy, Solana, EVM
- ‚úÖ Batch management
- ‚úÖ Frontend improvements (loading modal, amount conversion)

### v0.2.0
- ‚úÖ Relayer service for true privacy
- ‚úÖ Nullifier-based claims
- ‚úÖ Solana Devnet vault deployed
- ‚úÖ Sepolia ETH vault deployed
- ‚úÖ Double-spend protection
- ‚úÖ Multi-chain support

### v0.1.0
- Initial release
- Basic vault operations
- WOTS+ key pool management
